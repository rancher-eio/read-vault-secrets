---
name: Read Vault Secrets
description: "... it reads secrets from Vault?"
inputs:
  address:
    description: "the address of a deployed vault server"
    required: false
    default: https://vault.rancher.engineering
  secrets:
    description: "the secrets to fetch from the vault server"
    required: false
    default: secret/data/github-actions/test status
# outputs:
#   PROOF_OF_CONCEPT:
#     description: "the secret fetched from vault"
#     value: ${{ steps.vault.outputs.PROOF_OF_CONCEPT }}
# outputs:
#   secrets_json:  
#     description: "All secrets in JSON format"
runs:
  using: composite
  steps:
    - name: Read Secrets from Vault
      uses: hashicorp/vault-action@v3
      id: vault
      with:
        method: jwt
        url: ${{ inputs.address }}
        path: ${{ github.repository_owner }}
        role: ${{ github.event.repository.name }}
        secrets: ${{ inputs.secrets }}
        exportEnv: false
        # outputType: json
        
    - name: Export Specific Secrets to Environment
      shell: bash
      env:
        SECRETS_JSON: ${{ steps.vault.outputs.secrets }}
      run: |
        echo "$SECRETS_JSON" | jq -r 'to_entries | .[] | "echo \"::add-mask::"+.value+"\"\necho \""+.key+"="+.value+"\" >> $GITHUB_ENV"' | bash        
